<style>
  .qsm-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .qsm-modal.active {
    opacity: 1;
    pointer-events: auto;
  }

  /* Modal container - Two column layout */
  .qsm-container {
    max-width: 900px;
    width: 95%;
    max-height: 90vh;
    background: #fff;
    position: relative;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    transform: scale(0.9);
    transition: transform 0.3s ease;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
  }

  .qsm-modal.active .qsm-container {
    transform: scale(1);
  }

  /* Close button */
  .qsm-close {
    position: absolute;
    top: 15px;
    right: 15px;
    font-size: 28px;
    background: #fff;
    border: none;
    cursor: pointer;
    z-index: 100;
    color: #333;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  /* Two column layout */
  .qsm-content {
    display: flex;
    flex-direction: row;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  /* LEFT SIDE - Product Image Gallery */
  .qsm-images {
    width: 50%;
    height: 450px;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;

    /* Hide scrollbar */
    scrollbar-width: none;
    /* Firefox */
    -ms-overflow-style: none;
    /* IE 10+ */
  }

  .qsm-images::-webkit-scrollbar {
    display: none;
    /* Chrome, Safari, Edge */
  }


  .qsm-main-img {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 4px;
  }

  .qsm-thumb-imgs {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .qsm-thumb-img {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  /* RIGHT SIDE - Product Details */
  .qsm-details {
    width: 50%;
    display: flex;
    flex-direction: column;
    background: #fff;
    overflow-y: auto;
    padding: 20px;
  }

  .qsm-details-info {
    flex: 1;
    overflow-y: auto;
  }

  .qsm-details-footer {
    margin-top: auto;
    background: #fff;
  }

  .qsm-title {
    font-size: 32px;
    font-weight: 400;
    line-height: 40px;
    color: #333;
  }

  /* Stock Status */
  .qsm-stock-container {
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .qsm-stock-icon circle {
    transition: fill 0.2s ease
    , stroke 0.2s ease;
  }

  .qsm-stock-text {
    font-weight: 500;
    font-size: 16px;
    line-height: 24px;
    color: #00a52f;
  }

  /* Price */
  .qsm-price-container {
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .qsm-price {
    font-weight: 500;
    font-size: 18px;
    line-height: 26px;
    color: #333;
    margin: 0;
  }

  .qsm-compare-price {
    font-weight: 300;
    text-decoration: line-through;
    color: rgb(184, 179, 179);
    font-size: 16px;
    margin: 0;
  }

  /* Variant Options */
  .qsm-variant-option {
    margin-bottom: 10px;
  }

  .qsm-variant-option-name {
    color: #333;
    font-weight: 500;
    font-size: 14px;
    line-height: 20px;
    margin-bottom: 8px;
  }

  .qsm-option-values {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* Base variant button */
  .qsm-variant-box {
    padding: 8px 16px;
    font-weight: 400;
    font-size: 16px;
    line-height: 24px;
    color: #333;
    border: 2px solid #333;
    cursor: pointer;
    transition: all 0.12s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #fff;
  }

  .qsm-variant-box:hover {
    border-color: #0b0b0b;
  }

  .qsm-variant-box.selected {
    color: #fff;
    background-color: #333;
  }

  /* Swatch */
  .qsm-variant-swatch {
    border-radius: 50%;
    border: 2px solid transparent;
    width: 40px;
    height: 40px;
    display: inline-block;
    cursor: pointer;
    transition: all 0.12s ease;
    padding: 0;
  }

  .qsm-variant-swatch.selected {
    border-color: #333;
    transform: scale(1.05);
  }

  /* Quantity and Cart */
  .qsm-quantity-cart-container {
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .qsm-cart-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 48px;
    border: none;
    background: #333;
    color: #fff;
    padding: 0 18px;
    cursor: pointer;
    transition: background 0.12s ease;
    font-weight: 500;
    font-size: 16px;
    line-height: 24px;
  }

  .qsm-cart-btn:hover:not(:disabled) {
    background: #222;
  }

  .qsm-cart-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  .qsm-cart-btn .qsm-left-side {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .qsm-cart-btn p {
    margin: 0;
  }

  .qsm-quantity-control {
    display: flex;
    align-items: center;
    border: 2px solid #333;
    overflow: hidden;
    height: 48px;
    min-width: 120px;
    background: #fff;
  }

  .qsm-qty-btn {
    width: 40px;
    height: 100%;
    border: none;
    background: none;
    font-size: 20px;
    cursor: pointer;
    color: #333;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }

  .qsm-qty-btn:hover {
    background: #f5f5f5;
  }

  .qsm-qty-input {
    width: 40px;
    text-align: center;
    font-size: 16px;
    border: none;
    outline: none;
    font-weight: 500;
    -moz-appearance: textfield;
  }

  .qsm-qty-input::-webkit-outer-spin-button,
  .qsm-qty-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }


  /* Mobile Responsive */
  @media (max-width: 768px) {
    .qsm-container {
      overflow-y: auto;
    }

    .qsm-content {
      flex-direction: column;
      overflow-y: auto;
    }

    .qsm-images,
    .qsm-details {
      width: 100%;
      height: auto;
      flex: none;
    }

    .qsm-images {
      height: 350px;
    }

    .qsm-details {
      padding: 12px;
      overflow-y: visible;
    }

    .qsm-title {
      font-size: 24px;
      line-height: 32px;
    }

    .qsm-quantity-cart-container {
      flex-direction: column;
      align-items: stretch;
    }

    .qsm-quantity-control {
      width: 100%;
      justify-content: center;
    }

    .qsm-cart-btn {
      width: 100%;
      padding: 10px;
    }
  }
</style>

<div id="qsm-modal" class="qsm-modal">
  <div class="qsm-container">
    <button class="qsm-close" type="button">×</button>
    <div id="qsm-render-target">
      <!-- Content from qsm-variants.liquid will be injected here -->
    </div>
  </div>
</div>

<script>
  window.quickShopModal = { 
    product: {},
    variantId: null,
    variantsData: [],
    options: {}
  };
  
  // Static Elements
  const qsmModal = document.getElementById('qsm-modal');
  const qsmRenderTarget = document.getElementById('qsm-render-target');
  const qsmClose = document.querySelector('.qsm-close');
  
  async function openQuickShopModal(handle) {
    try {
      const sectionRes = await fetch('/products/' + handle + '?section_id=qsm-variants');
      const sectionHtml = await sectionRes.text();
      
      if (qsmRenderTarget) {
        qsmRenderTarget.innerHTML = sectionHtml;
        
        const jsonElem = qsmRenderTarget.querySelector('#qsm-variant-json');
        if (jsonElem) {
          const data = JSON.parse(jsonElem.textContent);
          window.quickShopModal.product = {
            title: data.title,
            options: data.options,
            featured_image: data.featured_image
          };
          window.quickShopModal.variantsData = data.variants;
          
          // Initialize options with the first variant
          const firstVariant = data.variants[0];
          window.quickShopModal.product.options.forEach(function(optName, i) {
            window.quickShopModal.options[optName] = firstVariant.options[i];
          });
          
          window.quickShopModal.variantId = firstVariant.id;
        }
  
        // Re-bind dynamic elements and setup
        handleQuickShopSetup();
        refreshModal();
      }
      
      if (qsmModal) {
        qsmModal.classList.add('active');
      }
    } catch (e) {
      console.error('Error opening quick shop modal:', e);
    }
  }
  
  window.openQuickShopModal = openQuickShopModal;
  
  function refreshModal() {
    const data = window.quickShopModal;
    const product = data.product;
    const options = data.options;
    
    // Find matching variant
    const variant = data.variantsData.find(function(v) {
      return product.options.every(function(optName, i) {
        return v.options[i] === options[optName];
      });
    });
  
    window.quickShopModal.variantId = variant ? variant.id : null;
  
    const qtyInput = document.getElementById('qsm-qty-input');
    const qsmAddToCart = document.getElementById('qsm-addToCart');
    const qsmPrice = document.getElementById('qsm-price');
    const qsmComparePrice = document.getElementById('qsm-compare-price');
    const qsmStock = document.getElementById('qsm-stock');
    const qsmStockIcon = document.querySelector('.qsm-stock-icon circle');
    const qsmAddToCartText = document.getElementById('qsm-addToCartText');
  
    if (qtyInput) qtyInput.value = 1;
  
    if (!variant) {
      if (qsmPrice) qsmPrice.textContent = 'Unavailable';
      if (qsmComparePrice) qsmComparePrice.style.display = 'none';
      if (qsmStock) {
        qsmStock.textContent = 'Unavailable';
        qsmStock.style.color = '#333';
      }
      if (qsmStockIcon) qsmStockIcon.style.fill = '#333';
      if (qsmAddToCart) qsmAddToCart.disabled = true;
      if (qsmAddToCartText) qsmAddToCartText.textContent = 'Unavailable';
      return;
    }
  
    // Update Pricing
    if (qsmPrice) qsmPrice.textContent = formatCurrency(variant.price);
  
    if (qsmComparePrice) {
      if (variant.compare_at_price > variant.price) {
        qsmComparePrice.textContent = formatCurrency(variant.compare_at_price);
        qsmComparePrice.style.display = 'block';
      } else {
        qsmComparePrice.style.display = 'none';
      }
    }
  
    // Update Stock Status
    if (qsmStock && qsmStockIcon) {
      if (variant.available) {
        qsmStock.textContent = variant.inventory_quantity > 0 ? 'Available in stock (' + variant.inventory_quantity + ')' : 'Available in stock';
        qsmStock.style.color = '#00A52F';
        qsmStockIcon.style.fill = '#00A52F';
        if (qsmAddToCart) qsmAddToCart.disabled = false;
        if (qsmAddToCartText) qsmAddToCartText.textContent = 'Add to Bag';
      } else {
        qsmStock.textContent = 'Out of Stock';
        qsmStock.style.color = '#333';
        qsmStockIcon.style.fill = '#333';
        if (qsmAddToCart) qsmAddToCart.disabled = true;
        if (qsmAddToCartText) qsmAddToCartText.textContent = 'Out of Stock';
      }
    }
  
    // Update main image and thumbnails visibility based on variant selection
    const mainImage = document.getElementById('qsm-main-img');
    const thumbnails = document.querySelectorAll('.qsm-thumb-img');
    const featuredImage = variant.featured_image || data.product.featured_image;
  
    if (featuredImage && mainImage) {
      const variantImgSrc = featuredImage.src || featuredImage; 
      
      if (typeof variantImgSrc === 'string') {
        const newSrc = variantImgSrc.replace(/\.(jpg|jpeg|png|webp).*/i, '_400x400.$1');
        if (mainImage.src !== newSrc) mainImage.src = newSrc;
      }
      mainImage.alt = variant.title || product.title;
  
      const imageId = featuredImage.id;
      thumbnails.forEach(thumb => {
        const thumbId = thumb.getAttribute('data-image-id');
        console.log("imageId--",imageId);
        // Use loose equality because one might be string and other number
        thumb.style.display = (thumbId == imageId) ? 'none' : 'block';
      });
    }
    
  
    // Update selection states
    const allVariantBtns = document.querySelectorAll('.qsm-variant-box');
    allVariantBtns.forEach(function(btn) {
      const name = btn.getAttribute('data-option-name');
      const val = btn.getAttribute('data-option-value');
      if (options[name] === val) {
        btn.classList.add('selected');
      } else {
        btn.classList.remove('selected');
      }
    });
  }
  
  function formatCurrency(cents) {
    return 'Rs.' + (cents / 100).toFixed(2);
  }
  
  async function handleAddToCart() {
    const qsmAddToCart = document.getElementById('qsm-addToCart');
    if (!qsmAddToCart) return;
    
    qsmAddToCart.classList.add('loading');
    
    const qtyInput = document.getElementById('qsm-qty-input');
    const quantity = qtyInput ? parseInt(qtyInput.value) : 1;
    
    try {
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: window.quickShopModal.variantId,
          quantity: quantity,
        }),
      });
  
      if (!response.ok) throw new Error('Failed to add item');
  
      if (window.openCartDrawer) window.openCartDrawer();
      if (window.updateCartCount) window.updateCartCount();
      
      closeQuickShopModal();
      document.dispatchEvent(new CustomEvent('cart:updated'));
    } catch (err) {
      console.error('Add to cart error:', err);
      if (window.showToast) window.showToast('❌ Failed to add to bag');
    } finally {
      qsmAddToCart.classList.remove('loading');
    }
  }
   
  function handleQuantityChange() {
    const qtyControl = document.getElementById('qsm-quantity-control');
    const qtyInput = document.getElementById('qsm-qty-input');
    
    if (!qtyControl || !qtyInput) return;
  
    qtyControl.addEventListener('click', function(e) {
      const data = window.quickShopModal;
      const variant = data.variantsData.find(function(v) {
        return v.id === data.variantId;
      });
      
      if (!variant) return;
      
      const isTracked = variant.inventory_management && variant.inventory_policy !== 'continue';
      const maxQty = isTracked ? variant.inventory_quantity : 9999;
      let currentVal = parseInt(qtyInput.value) || 1;
  
      if (e.target.matches('.increment-btn')) {
        if (currentVal < maxQty) {
          qtyInput.value = currentVal + 1;
        } else if (isTracked) {
          showToast('ℹ️ Not enough quantity available');
        } else {
          qtyInput.value = currentVal + 1;
        }
      }
  
      if (e.target.matches('.decrement-btn')) {
        if (currentVal > 1) {
          qtyInput.value = currentVal - 1;
        }
      }
    });
  
    qtyInput.addEventListener('change', function() {
      const data = window.quickShopModal;
      const variant = data.variantsData.find(function(v) {
        return v.id === data.variantId;
      });
      
      if (!variant) return;
  
      const isTracked = variant.inventory_management && variant.inventory_policy !== 'continue';
      const maxQty = isTracked ? variant.inventory_quantity : 9999;
      let val = parseInt(qtyInput.value) || 1;
  
      if (val < 1) val = 1;
      if (isTracked && val > maxQty) {
        val = maxQty;
      showToast('ℹ️ Not enough quantity available');
      }
      qtyInput.value = val;
    });
  }
  
  function closeQuickShopModal() {
    if (qsmModal) {
      qsmModal.classList.remove('active');
    }
  }
  
  function handleQuickShopSetup() {
    const qsmVariants = document.getElementById('qsm-variants');
    const qsmAddToCart = document.getElementById('qsm-addToCart');
  
    // Variant Selection
    if (qsmVariants) {
      qsmVariants.addEventListener('click', function(e) {
        const btn = e.target.closest('.qsm-variant-box');
        if (!btn) return;
        
        const name = btn.getAttribute('data-option-name');
        const val = btn.getAttribute('data-option-value');
        window.quickShopModal.options[name] = val;
        refreshModal();
      });
    }
  
    // Add to Cart btn
    if (qsmAddToCart) {
      qsmAddToCart.addEventListener('click', handleAddToCart);
    }
  
    handleQuantityChange();
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    // Statics
    if (qsmClose) {
      qsmClose.addEventListener('click', closeQuickShopModal);
    }
  
    window.addEventListener('click', function(e) {
      if (e.target === qsmModal) {
        closeQuickShopModal();
      }
    });
  });
</script>